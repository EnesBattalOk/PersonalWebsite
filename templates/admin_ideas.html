{% extends "admin_base.html" %}
{% block title %}Fikir Laboratuvarƒ±{% endblock %}
{% block content %}
<div class="pb-20">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold text-white">Fikir Laboratuvarƒ±</h1>
        <button onclick="openAddIdeaModal()" class="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-all shadow-lg shadow-violet-500/20">
            <i class="fas fa-plus mr-2"></i> Yeni Fikir Ekle
        </button>
    </div>

    <!-- TAB MENU (Centered Button Group) -->
    <div class="flex justify-center gap-4 mb-8">
        <button onclick="switchTab('fikir')" id="tab-fikir-btn" class="tab-button active px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 bg-violet-600 text-white shadow-lg shadow-violet-500/20">
            <i class="fas fa-lightbulb"></i> Fƒ∞Kƒ∞R HAVUZU
        </button>
        <button onclick="switchTab('aktif')" id="tab-aktif-btn" class="tab-button px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 bg-slate-800 text-slate-300 hover:bg-slate-700">
            <i class="fas fa-hammer"></i> AKTƒ∞F ≈ûANTƒ∞YE
        </button>
        <button onclick="switchTab('honor')" id="tab-honor-btn" class="tab-button px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 bg-slate-800 text-slate-300 hover:bg-slate-700">
            <i class="fas fa-trophy"></i> ONUR Lƒ∞STESƒ∞
        </button>
    </div>

    <!-- TAB 1: Fƒ∞Kƒ∞R HAVUZU (Masonry Grid) -->
    <div id="tab-fikir" class="tab-content active">
        <div class="flex items-center gap-3 mb-6">
            <i class="fas fa-lightbulb text-2xl text-yellow-400"></i>
            <h2 class="text-2xl font-bold text-white">Fikir Havuzu</h2>
            <span class="ml-auto text-sm text-slate-400">{{ fikirler|length }} fikir</span>
        </div>
        
        {% if fikirler %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-max">
            {% for fikir in fikirler %}
            <div class="bg-slate-800 rounded-xl border-2 border-dashed border-slate-600 p-6 flex flex-col hover:border-violet-500/50 transition-all">
                <!-- Title -->
                <h3 class="text-lg font-bold text-white mb-2 line-clamp-2">{{ fikir.baslik }}</h3>
                
                <!-- Problem (italic gray) -->
                {% if fikir.sorun %}
                <p class="text-sm text-slate-400 italic mb-4 line-clamp-2">{{ fikir.sorun }}</p>
                {% endif %}
                
                <!-- Elevator Pitch -->
                {% if fikir.ozet %}
                <p class="text-sm text-slate-300 mb-4">{{ fikir.ozet }}</p>
                {% endif %}
                
                <!-- Technologies (Colored Badges) -->
                {% if fikir.teknolojiler %}
                <div class="flex flex-wrap gap-2 mb-6">
                    {% for tech in fikir.teknolojiler.split(',') %}
                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-violet-500/20 text-violet-300 border border-violet-500/30">
                        {{ tech.strip() }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Action Buttons -->
                <div class="flex gap-2 mt-auto">
                    <button onclick="openPlanningModal({{ fikir.id }}, '{{ fikir.baslik }}')" class="flex-1 px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white font-semibold rounded-lg transition-all text-sm">
                        <i class="fas fa-rocket mr-1"></i> Ba≈ülat
                    </button>
                    <form action="{{ url_for('delete_idea', id=fikir.id) }}" method="POST" style="flex: 0;" onsubmit="return confirm('Sil?')">
                        <button type="submit" class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-all text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 bg-slate-800/50 rounded-xl border border-slate-700">
            <i class="fas fa-inbox text-4xl text-slate-500 mb-3"></i>
            <p class="text-slate-400">Hen√ºz hi√ß fikir yok. Yeni bir fikir eklemeye ba≈üla!</p>
        </div>
        {% endif %}
    </div>

    <!-- TAB 2: AKTƒ∞F ≈ûANTƒ∞YE (Expandable Cards with Mini-Kanban) -->
    <div id="tab-aktif" class="tab-content hidden">
        <div class="flex items-center gap-3 mb-6">
            <i class="fas fa-hammer text-2xl text-orange-400"></i>
            <h2 class="text-2xl font-bold text-white">Aktif ≈ûantiye</h2>
            <span class="ml-auto text-sm text-slate-400">{{ aktif_projeler|length }} proje</span>
        </div>
        
        {% if aktif_projeler %}
        <div class="space-y-4">
            {% for proje in aktif_projeler %}
            <div class="bg-slate-900 rounded-xl border-2 border-violet-500 p-6 shadow-lg shadow-violet-500/10">
                <!-- Project Header (Accordion Toggle) -->
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleProject({{ proje.id }})">
                    <div>
                        <h3 class="text-lg font-bold text-white">{{ proje.baslik }}</h3>
                        <div class="text-sm text-slate-300 mt-1">
                            <i class="fas fa-calendar mr-2 text-violet-400"></i>
                            {% if proje.bitis_tarihi %}
                                {% set days_left = ((proje.bitis_tarihi.timestamp() - now.timestamp()) / 86400)|int %}
                                {% if days_left > 0 %}
                                    <span>{{ days_left }} g√ºn kaldƒ±</span>
                                {% elif days_left == 0 %}
                                    <span class="text-orange-400 font-semibold">Bug√ºn bitmeli!</span>
                                {% else %}
                                    <span class="text-red-400 font-semibold">{{ abs(days_left) }} g√ºn gecikmi≈ü</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-slate-400 text-2xl">
                        <i class="fas fa-chevron-down" id="toggle-icon-{{ proje.id }}"></i>
                    </div>
                </div>

                <!-- Progress Bar (Auto-calculated) -->
                <div class="mt-4 mb-2">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-400">ƒ∞lerleme ({{ proje.biten_gorev }}/{{ proje.toplam_gorev }})</span>
                        <span class="text-sm font-bold text-violet-400">{{ "%.1f"|format(proje.ilerleme_yuzde) }}%</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                        <div class="bg-violet-600 h-2.5 rounded-full transition-all duration-500" style="width: {{ "%.1f"|format(proje.ilerleme_yuzde) }}%"></div>
                    </div>
                </div>

                <!-- Mini-Kanban (Hidden by default, shown when expanded) -->
                <div id="kanban-{{ proje.id }}" class="hidden mt-6 pt-6 border-t border-slate-700">
                    <h4 class="text-sm font-bold text-slate-300 mb-4 uppercase tracking-wide">G√∂rev Y√∂netimi</h4>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <!-- Column 1: YAPILACAKLAR -->
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                            <h5 class="font-semibold text-yellow-400 mb-3 text-sm">
                                <i class="fas fa-list-check mr-2"></i>YAPILACAKLAR
                            </h5>
                            <div class="space-y-2 kanban-column min-h-[150px]" id="col-yapilacak-{{ proje.id }}" data-project-id="{{ proje.id }}" data-status="YAPILACAK">
                                {% for gorev in proje.gorevler_sirali %}
                                    {% if gorev.durum == 'YAPILACAK' %}
                                    <div class="bg-slate-700 rounded p-3 text-sm text-slate-200 cursor-move task-card" draggable="true" data-task-id="{{ gorev.id }}">
                                        <p class="font-semibold">{{ gorev.baslik }}</p>
                                        {% if gorev.faz %}
                                        <p class="text-xs text-slate-400 mt-1">{{ gorev.faz }}</p>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Column 2: S√úR√úYOR -->
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                            <h5 class="font-semibold text-blue-400 mb-3 text-sm">
                                <i class="fas fa-spinner mr-2"></i>S√úR√úYOR
                            </h5>
                            <div class="space-y-2 kanban-column min-h-[150px]" id="col-suruyor-{{ proje.id }}" data-project-id="{{ proje.id }}" data-status="SURUYOR">
                                {% for gorev in proje.gorevler_sirali %}
                                    {% if gorev.durum == 'SURUYOR' %}
                                    <div class="bg-slate-700 rounded p-3 text-sm text-slate-200 cursor-move task-card" draggable="true" data-task-id="{{ gorev.id }}">
                                        <p class="font-semibold">{{ gorev.baslik }}</p>
                                        {% if gorev.faz %}
                                        <p class="text-xs text-slate-400 mt-1">{{ gorev.faz }}</p>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Column 3: Bƒ∞TTƒ∞ -->
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                            <h5 class="font-semibold text-emerald-400 mb-3 text-sm">
                                <i class="fas fa-check-circle mr-2"></i>Bƒ∞TTƒ∞
                            </h5>
                            <div class="space-y-2 kanban-column min-h-[150px]" id="col-bitti-{{ proje.id }}" data-project-id="{{ proje.id }}" data-status="BITTI">
                                {% for gorev in proje.gorevler_sirali %}
                                    {% if gorev.durum == 'BITTI' %}
                                    <div class="bg-slate-700 rounded p-3 text-sm text-slate-200 line-through text-slate-400 cursor-move task-card" draggable="true" data-task-id="{{ gorev.id }}">
                                        <p class="font-semibold">{{ gorev.baslik }}</p>
                                        {% if gorev.faz %}
                                        <p class="text-xs text-slate-500 mt-1">{{ gorev.faz }}</p>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-2 mt-6 pt-4 border-t border-slate-700">
                        <button onclick="openCompleteIdeaModal({{ proje.id }}, '{{ proje.baslik }}')" 
                                id="complete-btn-{{ proje.id }}"
                                class="flex-1 px-4 py-2 bg-slate-700 text-slate-400 font-semibold rounded-lg text-sm cursor-not-allowed" disabled>
                            <i class="fas fa-crown mr-1"></i> üèÜ Onur Listesine Ta≈üƒ±
                        </button>
                        <form action="{{ url_for('delete_idea', id=proje.id) }}" method="POST" style="flex: 0;" onsubmit="return confirm('Sil?')">
                            <button type="submit" class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-all text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 bg-slate-800/50 rounded-xl border border-slate-700">
            <i class="fas fa-inbox text-4xl text-slate-500 mb-3"></i>
            <p class="text-slate-400">≈ûu anda √ßalƒ±≈üan proje yok. Fikir havuzundan bir proje ba≈ülatabilirsin!</p>
        </div>
        {% endif %}
    </div>

    <!-- TAB 3: ONUR Lƒ∞STESƒ∞ -->
    <div id="tab-honor" class="tab-content hidden">
        <div class="flex items-center gap-3 mb-6">
            <i class="fas fa-trophy text-2xl text-yellow-400"></i>
            <h2 class="text-2xl font-bold text-white">Onur Listesi</h2>
            <span class="ml-auto text-sm text-slate-400">{{ biten_projeler|length }} tamamlanmƒ±≈ü</span>
        </div>
        
        {% if biten_projeler %}
        <div class="space-y-3">
            {% for proje in biten_projeler %}
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 flex items-center justify-between hover:bg-slate-800/80 transition-all">
                <!-- Left Side: Title & Date -->
                <div class="flex items-center gap-4 flex-grow min-w-0">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-2xl text-emerald-400"></i>
                    </div>
                    <div class="min-w-0">
                        <h4 class="font-bold text-white truncate">{{ proje.baslik }}</h4>
                        <p class="text-sm text-slate-400">
                            {% if proje.bitis_tarihi %}
                                <i class="fas fa-calendar mr-1 text-yellow-400"></i>
                                {{ proje.bitis_tarihi.strftime('%d.%m.%Y') }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                
                <!-- Right Side: Duration & Actions -->
                <div class="flex items-center gap-4">
                    {% if proje.baslangic_tarihi and proje.bitis_tarihi %}
                    <div class="text-right">
                        <p class="text-xs text-slate-500">S√ºre</p>
                        <p class="font-bold text-yellow-400">
                            {% set duration = (proje.bitis_tarihi - proje.baslangic_tarihi).days %}
                            {{ duration }} g√ºn
                        </p>
                    </div>
                    {% endif %}
                    <form action="{{ url_for('delete_idea', id=proje.id) }}" method="POST" style="flex: 0;" onsubmit="return confirm('Sil?')">
                        <button type="submit" class="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-all text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 bg-slate-800/50 rounded-xl border border-slate-700">
            <i class="fas fa-inbox text-4xl text-slate-500 mb-3"></i>
            <p class="text-slate-400">Hen√ºz tamamlanmƒ±≈ü proje yok. ƒ∞lk ba≈üarƒ±yƒ± elde etmeye ba≈üla!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- MODAL 1: "Yeni Fikir Ekle" -->
<div id="addIdeaModal" class="hidden fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl border border-slate-700 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-slate-900 border-b border-slate-700 p-6 flex items-center justify-between">
            <h2 class="text-2xl font-bold text-white">üí° Yeni Fikir Ekle</h2>
            <button onclick="closeAddIdeaModal()" class="text-slate-400 hover:text-white text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form action="{{ url_for('add_idea') }}" method="POST" class="p-6 space-y-6">
            <div>
                <label class="block text-sm font-medium text-slate-400 mb-2">Proje Adƒ±</label>
                <input type="text" name="baslik" required class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white focus:border-violet-500 outline-none focus:ring-2 focus:ring-violet-500/20">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-400 mb-2">Asans√∂r C√ºmlesi (√ñzet)</label>
                <textarea name="ozet" rows="2" required class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white focus:border-violet-500 outline-none resize-none focus:ring-2 focus:ring-violet-500/20" placeholder="Fikrin √∂z√ºn√º 1-2 c√ºmleyle anlatƒ±n..."></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-400 mb-2">√á√∂z√ºlen Sorun</label>
                <textarea name="sorun" rows="3" required class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white focus:border-violet-500 outline-none resize-none focus:ring-2 focus:ring-violet-500/20" placeholder="Bu fikir hangi sorunu √ß√∂zer?"></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-400 mb-2">Detaylƒ± A√ßƒ±klama</label>
                <textarea name="detay" rows="4" required class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white focus:border-violet-500 outline-none resize-none focus:ring-2 focus:ring-violet-500/20" placeholder="Detaylar, neden √∂nemli, fƒ±rsat nedir..."></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-400 mb-2">Teknolojiler</label>
                <input type="text" name="teknolojiler" class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white focus:border-violet-500 outline-none focus:ring-2 focus:ring-violet-500/20" placeholder="React, Node.js, MongoDB, ...">
            </div>
            
            <div class="flex gap-3 pt-4">
                <button type="submit" class="flex-1 px-6 py-3 bg-violet-600 hover:bg-violet-700 text-white font-bold rounded-lg transition-all">
                    <i class="fas fa-save mr-2"></i> Fikri Kaydet
                </button>
                <button type="button" onclick="closeAddIdeaModal()" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold rounded-lg transition-all">
                    ƒ∞ptal
                </button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL 2: "Detaylƒ± Planlama" (New - Plan project before starting) -->
<div id="planningModal" class="hidden fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl border border-slate-700 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-slate-900 border-b border-slate-700 p-6 flex items-center justify-between">
            <h2 class="text-2xl font-bold text-white">üìã Detaylƒ± Planlama</h2>
            <button onclick="closePlanningModal()" class="text-slate-400 hover:text-white text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-6 space-y-6">
            <!-- Project Info -->
            <div>
                <p class="text-sm text-slate-400 mb-2">Proje Adƒ±</p>
                <p id="planningTitle" class="font-bold text-white text-lg"></p>
            </div>
            
            <!-- Date Range -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Ba≈ülangƒ±√ß Tarihi</label>
                    <input type="date" id="planStartDate" class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white focus:border-violet-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Biti≈ü Tarihi</label>
                    <input type="date" id="planEndDate" class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white focus:border-violet-500 outline-none">
                </div>
            </div>

            <!-- Phase-Based Tasks Section -->
            <div>
                <label class="block text-sm font-medium text-slate-400 mb-3">A≈üamalar (Fazlar) ve G√∂revler</label>
                <div id="phasesList" class="space-y-4 mb-4">
                    <!-- Fazlar buraya dinamik olarak eklenir -->
                </div>
                <button type="button" onclick="addPhase()" class="px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg text-sm font-medium">
                    <i class="fas fa-plus mr-2"></i> Yeni Faz Ekle
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4 border-t border-slate-700">
                <button type="button" onclick="submitPlan()" class="flex-1 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition-all">
                    <i class="fas fa-play mr-2"></i> Projeyi Ba≈ülat
                </button>
                <button type="button" onclick="closePlanningModal()" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold rounded-lg transition-all">
                    ƒ∞ptal
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL 3: "Bitir" (Complete Project) -->
<div id="completeIdeaModal" class="hidden fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl border border-slate-700 max-w-md w-full">
        <div class="border-b border-slate-700 p-6 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white">üèÅ Projeyi Tamamla</h2>
            <button onclick="closeCompleteIdeaModal()" class="text-slate-400 hover:text-white text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="completeIdeaForm" method="POST" class="p-6 space-y-6">
            <div>
                <p class="text-sm text-slate-400 mb-2">Proje Adƒ±</p>
                <p id="completeIdeaTitle" class="font-bold text-white text-lg"></p>
            </div>
            
            <div class="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
                <p class="text-emerald-300 text-sm">‚ú® Tebrikler! Bu projeyi tamamlƒ±yorsun ve onur listesine eklenecek!</p>
            </div>
            
            <div class="flex gap-3 pt-4">
                <button type="submit" class="flex-1 px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition-all">
                    <i class="fas fa-crown mr-2"></i> Onur Listesine Ekle
                </button>
                <button type="button" onclick="closeCompleteIdeaModal()" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold rounded-lg transition-all">
                    ƒ∞ptal
                </button>
            </div>
        </form>
    </div>
</div>

<!-- CSS for Tabs & Slider -->
<style>
    .tab-button {
        transition: all 0.3s ease;
    }
    
    .tab-button.active {
        background-color: #7c3aed;
        color: white;
        box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
    }

    .tab-content {
        animation: fadeIn 0.3s ease;
    }

    .tab-content.hidden {
        display: none;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .slider::-webkit-slider-thumb {
        appearance: none;
        width: 18px;
        height: 18px;
        background: #8b5cf6;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid #6d28d9;
        box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    }
    
    .slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #8b5cf6;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid #6d28d9;
        box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    }

    .task-card {
        transition: background-color 0.2s ease;
    }

    .task-card:hover {
        background-color: #2d3748;
    }
</style>

<!-- JavaScript -->
<script>
    // ====================
    // TAB SWITCHING
    // ====================
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        document.getElementById('tab-' + tabName + '-btn').classList.add('active');
    }

    // ====================
    // PROJECT ACCORDION
    // ====================
    function toggleProject(projectId) {
        const kanban = document.getElementById('kanban-' + projectId);
        const icon = document.getElementById('toggle-icon-' + projectId);
        
        if (kanban.classList.contains('hidden')) {
            kanban.classList.remove('hidden');
            icon.classList.add('rotate-180');
        } else {
            kanban.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }

    // ====================
    // PLANNING MODAL
    // ====================
    let currentPlanningProjectId = null;

    function openPlanningModal(ideaId, ideaTitle) {
        currentPlanningProjectId = ideaId;
        document.getElementById('planningTitle').textContent = ideaTitle;
        
        const today = new Date().toISOString().split('T')[0];
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 30);
        
        document.getElementById('planStartDate').value = today;
        document.getElementById('planEndDate').value = endDate.toISOString().split('T')[0];
        
        // Reset phases
        document.getElementById('phasesList').innerHTML = '';
        
        document.getElementById('planningModal').classList.remove('hidden');
    }

    function closePlanningModal() {
        document.getElementById('planningModal').classList.add('hidden');
    }

    function addPhase() {
        const phasesList = document.getElementById('phasesList');
        const phaseNum = phasesList.children.length + 1;
        const phaseId = 'phase-' + Date.now();
        
        const phaseDiv = document.createElement('div');
        phaseDiv.className = 'bg-slate-800 border border-slate-700 rounded-lg p-4';
        phaseDiv.id = phaseId;
        phaseDiv.innerHTML = `
            <div class="flex gap-2 mb-3">
                <input type="text" placeholder="Faz Adƒ± (√∂r: Faz 1: Veritabanƒ±)" class="flex-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm font-medium phase-name" required>
                <button type="button" onclick="removePhase('${phaseId}')" class="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-sm">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="space-y-2 phase-tasks mb-3">
                <!-- G√∂revler buraya eklenir -->
            </div>
            <button type="button" onclick="addTaskToPhase('${phaseId}')" class="w-full px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg text-sm text-center">
                <i class="fas fa-plus mr-1"></i> Bu Faza G√∂rev Ekle
            </button>
        `;
        
        phasesList.appendChild(phaseDiv);
    }

    function removePhase(phaseId) {
        document.getElementById(phaseId).remove();
    }

    function addTaskToPhase(phaseId) {
        const phaseDiv = document.getElementById(phaseId);
        const tasksList = phaseDiv.querySelector('.phase-tasks');
        const taskId = 'task-' + Date.now();
        
        const taskDiv = document.createElement('div');
        taskDiv.className = 'flex gap-2';
        taskDiv.id = taskId;
        taskDiv.innerHTML = `
            <input type="text" placeholder="G√∂rev adƒ±" class="flex-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm task-title" required>
            <input type="date" class="w-32 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm task-date" required>
            <button type="button" onclick="removeTask('${taskId}')" class="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-sm">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        tasksList.appendChild(taskDiv);
    }

    function removeTask(taskId) {
        document.getElementById(taskId).remove();
    }

    function submitPlan() {
        const startDate = document.getElementById('planStartDate').value;
        const endDate = document.getElementById('planEndDate').value;
        
        // Tarih kontrol√º
        if (!startDate || !endDate) {
            alert('‚ö†Ô∏è Ba≈ülangƒ±√ß ve biti≈ü tarihlerini belirtmelisin!');
            return;
        }
        
        if (new Date(startDate) > new Date(endDate)) {
            alert('‚ö†Ô∏è Ba≈ülangƒ±√ß tarihi biti≈ü tarihinden √∂nce olmalƒ±dƒ±r!');
            return;
        }
        
        // Faz bazlƒ± g√∂revleri topla
        const tasks = [];
        const phases = document.querySelectorAll('[id^="phase-"]');
        let hasEmptyFields = false;
        let totalTasks = 0;
        
        phases.forEach(phaseDiv => {
            const phaseName = phaseDiv.querySelector('.phase-name').value.trim();
            
            if (!phaseName) {
                hasEmptyFields = true;
                return;
            }
            
            const taskElements = phaseDiv.querySelectorAll('[id^="task-"]');
            
            taskElements.forEach(taskDiv => {
                const taskTitle = taskDiv.querySelector('.task-title').value.trim();
                const taskDate = taskDiv.querySelector('.task-date').value.trim();
                
                if (!taskTitle || !taskDate) {
                    hasEmptyFields = true;
                    return;
                }
                
                tasks.push({
                    baslik: taskTitle,
                    faz: phaseName,
                    baslangic_tarihi: taskDate
                });
                totalTasks++;
            });
        });
        
        // Bo≈ü alanlar varsa uyarƒ± ver
        if (hasEmptyFields) {
            alert('‚ö†Ô∏è L√ºtfen t√ºm faz ve g√∂rev bilgilerini eksiksiz doldurun!');
            return;
        }
        
        // Hi√ß g√∂rev eklenmemi≈üse uyarƒ± ver
        if (totalTasks === 0) {
            alert('‚ö†Ô∏è En az bir g√∂rev eklemelisiniz!');
            return;
        }
        
        // G√∂revleri kaydet
        fetch(`/admin/ideas/plan_save/${currentPlanningProjectId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ gorevler: tasks })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Then, start the project
                startProjectWithDates(startDate, endDate);
            } else {
                alert('‚ùå G√∂revler kaydedilirken hata olu≈ütu!');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('‚ùå Bir hata olu≈ütu!');
        });
    }

    function startProjectWithDates(startDate, endDate) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/ideas/start/${currentPlanningProjectId}`;
        form.innerHTML = `
            <input type="hidden" name="baslangic_tarihi" value="${startDate}">
            <input type="hidden" name="bitis_tarihi" value="${endDate}">
        `;
        document.body.appendChild(form);
        form.submit();
    }

    // ====================
    // MODALS
    // ====================
    function openAddIdeaModal() {
        document.getElementById('addIdeaModal').classList.remove('hidden');
        document.getElementById('addIdeaModal').querySelector('form').reset();
    }

    function closeAddIdeaModal() {
        document.getElementById('addIdeaModal').classList.add('hidden');
    }

    function openCompleteIdeaModal(ideaId, ideaTitle) {
        document.getElementById('completeIdeaTitle').textContent = ideaTitle;
        document.getElementById('completeIdeaForm').action = `/admin/ideas/complete/${ideaId}`;
        document.getElementById('completeIdeaModal').classList.remove('hidden');
    }

    function closeCompleteIdeaModal() {
        document.getElementById('completeIdeaModal').classList.add('hidden');
    }

    // ====================
    // TASK MANAGEMENT
    // ====================
    function updateTaskStatus(taskId, status) {
        fetch(`/admin/ideas/task_update/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ durum: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Hata:', error));
    }

    // ====================
    // PROGRESS SLIDER
    // ====================
    function updateProgress(ideaId, progress) {
        fetch(`/admin/ideas/progress/${ideaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ ilerleme: parseInt(progress) })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Hata:', data.error);
            }
        })
        .catch(error => console.error('Hata:', error));
    }

    // ====================
    // KANBAN DRAG & DROP (SortableJS)
    // ====================
    function initKanban() {
        const columns = document.querySelectorAll('.kanban-column');
        
        columns.forEach(column => {
            new Sortable(column, {
                group: {
                    name: `kanban-${column.dataset.projectId}`,
                    pull: true,
                    put: true
                },
                animation: 150,
                ghostClass: 'opacity-50',
                onEnd: function(evt) {
                    const taskCard = evt.item;
                    const taskId = taskCard.dataset.taskId;
                    const newStatus = evt.to.dataset.status;
                    
                    // Update task status
                    updateTaskStatus(taskId, newStatus);
                }
            });
        });
    }

    // ====================
    // COMPLETION CONTROL
    // ====================
    function checkCompletion(projectId) {
        const bittiColumn = document.getElementById(`col-bitti-${projectId}`);
        const yapilacakColumn = document.getElementById(`col-yapilacak-${projectId}`);
        const suruyorColumn = document.getElementById(`col-suruyor-${projectId}`);
        
        const yapilacakTasks = yapilacakColumn.querySelectorAll('[data-task-id]').length;
        const suruyorTasks = suruyorColumn.querySelectorAll('[data-task-id]').length;
        const bittiTasks = bittiColumn.querySelectorAll('[data-task-id]').length;
        
        // Eƒüer t√ºm g√∂revler "Bitti" ise butonu aktif et
        const completeBtn = document.getElementById(`complete-btn-${projectId}`);
        if (bittiTasks > 0 && yapilacakTasks === 0 && suruyorTasks === 0) {
            completeBtn.disabled = false;
            completeBtn.classList.remove('bg-slate-700', 'text-slate-400', 'cursor-not-allowed');
            completeBtn.classList.add('bg-emerald-600', 'text-white', 'hover:bg-emerald-700', 'cursor-pointer');
        } else {
            completeBtn.disabled = true;
            completeBtn.classList.remove('bg-emerald-600', 'text-white', 'hover:bg-emerald-700', 'cursor-pointer');
            completeBtn.classList.add('bg-slate-700', 'text-slate-400', 'cursor-not-allowed');
        }
    }

    // Override updateTaskStatus to check completion after update
    const originalUpdateTaskStatus = window.updateTaskStatus;
    window.updateTaskStatus = function(taskId, status) {
        fetch(`/admin/ideas/task_update/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ durum: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Get project ID from task card
                const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskCard) {
                    // Move card to correct column
                    const projectId = taskCard.closest('.kanban-column').dataset.projectId;
                    const newColumn = document.getElementById(`col-${status.toLowerCase()}-${projectId}`);
                    
                    if (newColumn) {
                        // Update visual styling if moving to BITTI
                        if (status === 'BITTI') {
                            taskCard.classList.add('line-through', 'text-slate-400');
                            taskCard.classList.remove('text-slate-200');
                        } else {
                            taskCard.classList.remove('line-through', 'text-slate-400');
                            taskCard.classList.add('text-slate-200');
                        }
                        
                        newColumn.appendChild(taskCard);
                        checkCompletion(projectId);
                    }
                }
            }
        })
        .catch(error => console.error('Hata:', error));
    };

    // Initialize: rotate toggle icons & setup Kanban
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[id^="toggle-icon-"]').forEach(icon => {
            icon.style.transition = 'transform 0.3s ease';
        });
        
        // Initialize Kanban for all projects
        initKanban();
        
        // Check completion for all active projects
        document.querySelectorAll('[id^="col-bitti-"]').forEach(bittiCol => {
            const projectId = bittiCol.id.match(/col-bitti-(\d+)/)[1];
            checkCompletion(projectId);
        });
    });
</script>

{% endblock %}
