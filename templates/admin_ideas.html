{% extends "admin_base.html" %}
{% block title %}Fikir LaboratuvarÄ±{% endblock %}
{% block content %}
<div class="pb-20">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold text-white">Fikir LaboratuvarÄ±</h1>
        <button onclick="openAddIdeaModal()" class="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-all shadow-lg shadow-violet-500/20">
            <i class="fas fa-plus mr-2"></i> Yeni Fikir Ekle
        </button>
    </div>

    <!-- TAB MENU (Centered Button Group) -->
    <div class="flex justify-center gap-4 mb-8">
        <button onclick="switchTab('fikir')" id="tab-fikir-btn" class="tab-button active px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 bg-violet-600 text-white shadow-lg shadow-violet-500/20">
            <i class="fas fa-lightbulb"></i> FÄ°KÄ°R HAVUZU
        </button>
        <button onclick="switchTab('aktif')" id="tab-aktif-btn" class="tab-button px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 bg-slate-800 text-slate-300 hover:bg-slate-700">
            <i class="fas fa-hammer"></i> AKTÄ°F ÅžANTÄ°YE
        </button>
        <button onclick="switchTab('honor')" id="tab-honor-btn" class="tab-button px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 bg-slate-800 text-slate-300 hover:bg-slate-700">
            <i class="fas fa-trophy"></i> ONUR LÄ°STESÄ°
        </button>
    </div>

    <!-- TAB 1: FÄ°KÄ°R HAVUZU (Masonry Grid) -->
    <div id="tab-fikir" class="tab-content active">
        <div class="flex items-center gap-3 mb-6">
            <i class="fas fa-lightbulb text-2xl text-yellow-400"></i>
            <h2 class="text-2xl font-bold text-white">Fikir Havuzu</h2>
            <span class="ml-auto text-sm text-slate-400">{{ fikirler|length if fikirler else 0 }} fikir</span>
        </div>
        
        {% if fikirler %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-max">
            {% for fikir in fikirler %}
            <div class="bg-slate-800 rounded-xl border-2 border-dashed border-slate-600 p-6 flex flex-col hover:border-violet-500/50 transition-all">
                <!-- Title -->
                <h3 class="text-lg font-bold text-white mb-2 line-clamp-2">{{ fikir.baslik }}</h3>
                
                <!-- Problem (italic gray) -->
                {% if fikir.sorun %}
                <p class="text-sm text-slate-400 italic mb-4 line-clamp-2">{{ fikir.sorun }}</p>
                {% endif %}
                
                <!-- Elevator Pitch -->
                {% if fikir.ozet %}
                <p class="text-sm text-slate-300 mb-4">{{ fikir.ozet }}</p>
                {% endif %}
                
                <!-- Technologies (Colored Badges) -->
                {% if fikir.teknolojiler %}
                <div class="flex flex-wrap gap-2 mb-6">
                    {% for tech in fikir.teknolojiler.split(',') %}
                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-violet-500/20 text-violet-300 border border-violet-500/30">
                        {{ tech.strip() }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Action Buttons -->
                <div class="flex gap-2 mt-auto">
                    <button onclick="openPlanningModal({{ fikir.id }}, '{{ fikir.baslik }}')" class="flex-1 px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white font-semibold rounded-lg transition-all text-sm">
                        <i class="fas fa-rocket mr-1"></i> BaÅŸlat
                    </button>
                    <form action="{{ url_for('delete_idea', id=fikir.id) }}" method="POST" style="flex: 0;" onsubmit="return confirm('Sil?')">
                        <button type="submit" class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-all text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 bg-slate-800/50 rounded-xl border border-slate-700">
            <i class="fas fa-inbox text-4xl text-slate-500 mb-3"></i>
            <p class="text-slate-400">HenÃ¼z hiÃ§ fikir yok. Yeni bir fikir eklemeye baÅŸla!</p>
        </div>
        {% endif %}
    </div>

    <!-- TAB 2: AKTÄ°F ÅžANTÄ°YE -->
    <div id="tab-aktif" class="tab-content hidden">
        <div class="flex items-center gap-3 mb-6">
            <i class="fas fa-hammer text-2xl text-orange-400"></i>
            <h2 class="text-2xl font-bold text-white">Aktif Åžantiye</h2>
            <span class="ml-auto text-sm text-slate-400">{{ aktif_projeler|length if aktif_projeler else 0 }} proje</span>
        </div>
        
        {% if aktif_projeler %}
        <div class="space-y-4">
            {% for proje in aktif_projeler %}
            <div class="bg-slate-900 rounded-xl border-2 border-violet-500 p-6 shadow-lg shadow-violet-500/10">
                <div class="flex items-center justify-between">
                    <div class="cursor-pointer flex-1" onclick="toggleProject({{ proje.id }})">
                        <h3 class="text-lg font-bold text-white">{{ proje.baslik }}</h3>
                        <div class="text-sm text-slate-300 mt-1">
                            <i class="fas fa-calendar mr-2 text-violet-400"></i>
                            {% if proje.bitis_tarihi %}
                                {% set now = now if now else 0 %}
                                <span>Tarih kontrolÃ¼ yapÄ±lÄ±yor...</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="openProjectMap({{ proje.id }}, '{{ proje.baslik }}')" class="px-3 py-2 bg-violet-500/20 hover:bg-violet-500/40 text-violet-300 rounded-lg text-sm transition-all">
                            <i class="fas fa-map mr-1"></i> Harita
                        </button>
                        <div class="text-slate-400 text-2xl cursor-pointer" onclick="toggleProject({{ proje.id }})">
                            <i class="fas fa-chevron-down" id="toggle-icon-{{ proje.id }}"></i>
                        </div>
                    </div>
                </div>

                <div class="mt-4 mb-2">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-400">Ä°lerleme</span>
                        <span class="text-sm font-bold text-violet-400">{{ "%.1f"|format(proje.ilerleme_yuzde|default(0)) }}%</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                        <div class="bg-violet-600 h-2.5 rounded-full transition-all duration-500" style="width: {{ "%.1f"|format(proje.ilerleme_yuzde|default(0)) }}%"></div>
                    </div>
                </div>

                <div id="kanban-{{ proje.id }}" class="hidden mt-6 pt-6 border-t border-slate-700">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                            <h5 class="font-semibold text-yellow-400 mb-3 text-sm">YAPILACAKLAR</h5>
                            <div class="space-y-2 kanban-column min-h-[100px]" id="col-yapilacak-{{ proje.id }}" data-project-id="{{ proje.id }}" data-status="YAPILACAK">
                                {% for gorev in proje.gorevler %}
                                    {% if gorev.durum == 'YAPILACAK' %}
                                    <div class="bg-slate-700 rounded p-3 text-sm text-slate-200" data-task-id="{{ gorev.id }}">
                                        {{ gorev.baslik }}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                            <h5 class="font-semibold text-blue-400 mb-3 text-sm">SÃœRÃœYOR</h5>
                            <div class="space-y-2 kanban-column min-h-[100px]" id="col-suruyor-{{ proje.id }}" data-project-id="{{ proje.id }}" data-status="SURUYOR">
                                {% for gorev in proje.gorevler %}
                                    {% if gorev.durum == 'SURUYOR' %}
                                    <div class="bg-slate-700 rounded p-3 text-sm text-slate-200" data-task-id="{{ gorev.id }}">
                                        {{ gorev.baslik }}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                            <h5 class="font-semibold text-emerald-400 mb-3 text-sm">BÄ°TTÄ°</h5>
                            <div class="space-y-2 kanban-column min-h-[100px]" id="col-bitti-{{ proje.id }}" data-project-id="{{ proje.id }}" data-status="BITTI">
                                {% for gorev in proje.gorevler %}
                                    {% if gorev.durum == 'BITTI' %}
                                    <div class="bg-slate-700 rounded p-3 text-sm text-slate-400 line-through" data-task-id="{{ gorev.id }}">
                                        {{ gorev.baslik }}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- TAB 3: ONUR LÄ°STESÄ° -->
    <div id="tab-honor" class="tab-content hidden">
        <div class="flex items-center gap-3 mb-6">
            <i class="fas fa-trophy text-2xl text-yellow-400"></i>
            <h2 class="text-2xl font-bold text-white">Onur Listesi</h2>
            <span class="ml-auto text-sm text-slate-400">{{ biten_projeler|length if biten_projeler else 0 }} tamamlanmÄ±ÅŸ</span>
        </div>
        
        {% if biten_projeler %}
        <div class="space-y-3">
            {% for proje in biten_projeler %}
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <i class="fas fa-check-circle text-2xl text-emerald-400"></i>
                    <div>
                        <h4 class="font-bold text-white">{{ proje.baslik }}</h4>
                        <p class="text-sm text-slate-400">{{ proje.bitis_tarihi.strftime('%d.%m.%Y') if proje.bitis_tarihi else '' }}</p>
                    </div>
                </div>
                <form action="{{ url_for('delete_idea', id=proje.id) }}" method="POST">
                    <button type="submit" class="px-3 py-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500/20">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- MODALS -->
<div id="addIdeaModal" class="hidden fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl border border-slate-700 max-w-2xl w-full p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-white">ðŸ’¡ Yeni Fikir Ekle</h2>
            <button onclick="closeAddIdeaModal()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <form action="{{ url_for('add_idea') }}" method="POST" class="space-y-4">
            <input type="text" name="baslik" placeholder="Proje AdÄ±" required class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white">
            <textarea name="ozet" placeholder="Ã–zet" required class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white"></textarea>
            <textarea name="sorun" placeholder="Sorun" required class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white"></textarea>
            <textarea name="detay" placeholder="Detay" required class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white"></textarea>
            <input type="text" name="teknolojiler" placeholder="Teknolojiler" class="w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white">
            <button type="submit" class="w-full py-3 bg-violet-600 text-white font-bold rounded-lg">Fikri Kaydet</button>
        </form>
    </div>
</div>

<div id="planningModal" class="hidden fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl border border-slate-700 max-w-2xl w-full p-6">
        <h2 class="text-2xl font-bold text-white mb-6">ðŸ“‹ Planlama</h2>
        <div id="planningTitle" class="text-white mb-4"></div>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <input type="date" id="planStartDate" class="bg-slate-800 text-white p-2 rounded">
            <input type="date" id="planEndDate" class="bg-slate-800 text-white p-2 rounded">
        </div>
        <button onclick="submitPlan()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-lg">BaÅŸlat</button>
    </div>
</div>

<script>
    function switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(x => x.classList.add('hidden'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        document.querySelectorAll('.tab-button').forEach(x => x.classList.remove('active', 'bg-violet-600', 'text-white'));
        document.getElementById('tab-'+t+'-btn').classList.add('active', 'bg-violet-600', 'text-white');
    }
    function toggleProject(id) {
        document.getElementById('kanban-'+id).classList.toggle('hidden');
    }
    function openAddIdeaModal() { document.getElementById('addIdeaModal').classList.remove('hidden'); }
    function closeAddIdeaModal() { document.getElementById('addIdeaModal').classList.add('hidden'); }
    function openPlanningModal(id, title) {
        currentPlanningProjectId = id;
        document.getElementById('planningTitle').textContent = title;
        document.getElementById('planningModal').classList.remove('hidden');
    }
    function submitPlan() {
        const s = document.getElementById('planStartDate').value;
        const e = document.getElementById('planEndDate').value;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/ideas/start/' + currentPlanningProjectId;
        form.innerHTML = `<input type="hidden" name="baslangic_tarihi" value="${s}"><input type="hidden" name="bitis_tarihi" value="${e}">`;
        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}
